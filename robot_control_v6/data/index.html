<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ƒêi·ªÅu khi·ªÉn Robot Mecanum</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      margin: 20px;
    }

    .arrow-buttons button {
      font-size: 20px;
      padding: 10px 20px;
      margin: 5px;
    }

    .velocity-inputs {
      margin-top: 15px;
    }

    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>üõ∏ ƒêi·ªÅu khi·ªÉn Robot Mecanum</h2>

  <!-- N√∫t m≈©i t√™n -->
  <div class="arrow-buttons">
    <div>
      <button onclick="sendVelocity(0.2, 0, 0)">‚¨ÜÔ∏è Ti·∫øn</button>
    </div>
    <div>
      <button onclick="sendVelocity(0, -0.2, 0)">‚¨ÖÔ∏è Tr√°i</button>
      <button onclick="sendVelocity(0, 0, 0.5)">‚§¥Ô∏è Quay tr√°i</button>
      <button onclick="sendVelocity(0, 0, -0.5)">‚§µÔ∏è Quay ph·∫£i</button>
      <button onclick="sendVelocity(0, 0.2, 0)">‚û°Ô∏è Ph·∫£i</button>
    </div>
    <div class="control-grid">
      <button onclick="sendDirection(0.5, 0.5, 0)">‚Üó</button>
      <button onclick="sendDirection(0.5, -0.5, 0)">‚Üñ</button>
      <button onclick="sendDirection(-0.5, 0.5, 0)">‚Üò</button>
      <button onclick="sendDirection(-0.5, -0.5, 0)">‚Üô</button>
    </div>
    
    <div>
      <button onclick="sendVelocity(-0.2, 0, 0)">‚¨áÔ∏è L√πi</button>
    </div>
    <div>
      <button onclick="sendVelocity(0, 0, 0)">‚èπÔ∏è D·ª´ng</button>
    </div>
  </div>

  <!-- Nh·∫≠p gi√° tr·ªã vx vy omega -->
  <div class="velocity-inputs">
    <label>vx (m/s): <input type="number" id="vx" step="0.01" value="0"></label>
    <label>vy (m/s): <input type="number" id="vy" step="0.01" value="0"></label>
    <label>omega (rad/s): <input type="number" id="omega" step="0.01" value="0"></label>
    <button onclick="sendCustomVelocity()">üì§ G·ª≠i l·ªánh</button>
  </div>

  <!-- Bi·ªÉu ƒë·ªì t·ªëc ƒë·ªô -->
  <canvas id="speedChart" width="400" height="200"></canvas>

  <script>
    function sendVelocity(vx, vy, omega) {
      fetch(`/cmd?vx=${vx}&vy=${vy}&omega=${omega}`)
        .then(res => res.text())
        .then(text => console.log(text));
    }

    function sendCustomVelocity() {
      const vx = parseFloat(document.getElementById('vx').value);
      const vy = parseFloat(document.getElementById('vy').value);
      const omega = parseFloat(document.getElementById('omega').value);
      sendVelocity(vx, vy, omega);
    }

    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì m·ªói 500ms
    setInterval(() => {
      fetch('/getSpeeds')
        .then(res => res.json())
        .then(data => {
          updateChart(data.v1, data.v2, data.v3, data.v4);
        });
    }, 500);

    // T·∫°o bi·ªÉu ƒë·ªì Chart.js
    const ctx = document.getElementById('speedChart').getContext('2d');
    const labels = Array.from({length: 20}, (_, i) => i.toString());
    const data = {
      labels: labels,
      datasets: [
        {
          label: 'B√°nh 1',
          data: Array(20).fill(0),
          borderColor: 'red',
          fill: false
        },
        {
          label: 'B√°nh 2',
          data: Array(20).fill(0),
          borderColor: 'green',
          fill: false
        },
        {
          label: 'B√°nh 3',
          data: Array(20).fill(0),
          borderColor: 'blue',
          fill: false
        },
        {
          label: 'B√°nh 4',
          data: Array(20).fill(0),
          borderColor: 'orange',
          fill: false
        }
      ]
    };

    const config = {
      type: 'line',
      data: data,
      options: {
        animation: false,
        responsive: true,
        scales: {
          y: {
            title: {
              display: true,
              text: 'PWM'
            }
          },
          x: {
            title: {
              display: true,
              text: 'L·∫ßn c·∫≠p nh·∫≠t'
            }
          }
        }
      }
    };

    const speedChart = new Chart(ctx, config);

    function updateChart(v1, v2, v3, v4) {
      const maxPoints = 20;
      const d = speedChart.data.datasets;
      d[0].data.push(v1); d[0].data.shift();
      d[1].data.push(v2); d[1].data.shift();
      d[2].data.push(v3); d[2].data.shift();
      d[3].data.push(v4); d[3].data.shift();
      speedChart.update();
    }
  </script>
</body>
</html>
